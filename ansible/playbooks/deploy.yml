---
# =====================================================
# MAIN DEPLOYMENT PLAYBOOK
# Deploys Python and Java applications to target servers
# =====================================================

- name: Deploy AnsibleJenkinsCICD Application
  hosts: all
  become: yes
  
  vars:
    app_name: AnsibleJenkinsCICD
    app_version: "1.0.0"
    deploy_path: /opt/{{ app_name }}
    python_app_path: "{{ deploy_path }}/python"
    java_app_path: "{{ deploy_path }}/java"
    
  tasks:
    # =====================================================
    # PREREQUISITES
    # =====================================================
    - name: üì¶ Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"

    - name: üì¶ Install required packages
      apt:
        name:
          - python3
          - python3-pip
          - openjdk-11-jre
          - git
        state: present
      when: ansible_os_family == "Debian"

    # =====================================================
    # CREATE DIRECTORIES
    # =====================================================
    - name: üìÅ Create application directory
      file:
        path: "{{ deploy_path }}"
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: üìÅ Create Python app directory
      file:
        path: "{{ python_app_path }}"
        state: directory
        mode: '0755'

    - name: üìÅ Create Java app directory
      file:
        path: "{{ java_app_path }}"
        state: directory
        mode: '0755'

    # =====================================================
    # DEPLOY PYTHON APPLICATION
    # =====================================================
    - name: üêç Copy Python application files
      copy:
        src: "{{ playbook_dir }}/../../python/"
        dest: "{{ python_app_path }}/"
        mode: '0644'
      notify: Restart Python App

    - name: üêç Install Python dependencies
      pip:
        requirements: "{{ python_app_path }}/requirements.txt"
        executable: pip3
      ignore_errors: yes

    # =====================================================
    # DEPLOY JAVA APPLICATION
    # =====================================================
    - name: ‚òï Copy Java JAR file
      copy:
        src: "{{ playbook_dir }}/../../java/target/my-first-app-1.0.0.jar"
        dest: "{{ java_app_path }}/app.jar"
        mode: '0644'
      ignore_errors: yes
      notify: Restart Java App

    # =====================================================
    # CREATE SYSTEMD SERVICES (Optional)
    # =====================================================
    - name: üìù Create Python systemd service
      template:
        src: python-app.service.j2
        dest: /etc/systemd/system/python-app.service
      notify: Reload Systemd
      ignore_errors: yes

    # =====================================================
    # DEPLOYMENT INFO
    # =====================================================
    - name: üéâ Display deployment info
      debug:
        msg: |
          ====================================
          üöÄ DEPLOYMENT COMPLETE!
          ====================================
          App Name: {{ app_name }}
          Version: {{ app_version }}
          Deploy Path: {{ deploy_path }}
          Environment: {{ env_name | default('unknown') }}
          Server: {{ inventory_hostname }}
          ====================================

  # =====================================================
  # HANDLERS
  # =====================================================
  handlers:
    - name: Reload Systemd
      systemd:
        daemon_reload: yes

    - name: Restart Python App
      debug:
        msg: "Python app would be restarted here"

    - name: Restart Java App
      debug:
        msg: "Java app would be restarted here"

